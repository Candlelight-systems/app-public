'use strict';

function _interopDefault (ex) { return (ex && (typeof ex === 'object') && 'default' in ex) ? ex['default'] : ex; }

var React = _interopDefault(require('react'));
var ReactDOM = _interopDefault(require('react-dom'));
var path = _interopDefault(require('path'));
var url = _interopDefault(require('url'));
var jquery = _interopDefault(require('jquery'));
var fs = _interopDefault(require('fs'));
require('electron');
var Graph = _interopDefault(require('node-jsgraph/dist/jsgraph-es6'));
var PDFDocument = _interopDefault(require('pdfkit'));

class Header extends React.Component{constructor(a){super(a);}render(){let a=0;if(this.props.channels){this.props.channels.length;let b;for(b of this.props.channels)b.busy&&a++;}return React.createElement('nav',{className:'header navbar navbar-default'},React.createElement('div',{className:'container-fluid'},React.createElement('div',{className:'navbar-left'},React.createElement('img',{src:'./images/logo.png',width:'350'}))))}}

const PythonShell=require('python-shell');
const path$1=require('path');class KeithleySMU{static list(){return new Promise((a,b)=>{var c=new PythonShell('script.list',{pythonOptions:['-m'],cwd:path$1.join(__dirname.replace('app.asar','app.asar.unpacked'),'../util/pyvisa/'),mode:'text'});c.once('error',a=>{a=a.toString('utf-8'), c.removeAllListeners('message'), b(a);}), c.once('message',d=>{d=d.toString('utf-8'), c.removeAllListeners('error'), Array.isArray(d)&&(d=d[0]);let e=/\((.*)\)/gim.exec(d);return e&&e[1]?0==e[1].length?void b():void(e=e[1].split(',').map(a=>(a=/u'(.*)'/g.exec(a), a&&a[1]?a[1]:null)), a(e)):b()});})}constructor(a){this.host=a;}connect(){return this.visaShell&&(this.visaShell.removeAllListeners('message'), this.visaShell.removeAllListeners('error'), this.visaShell=null), new Promise((a,b)=>{var c=setTimeout(()=>{this.visaShell.end(()=>{b('Cannot connect');});},1e3);try{this.visaShell=new PythonShell('script.iovisa',{cwd:path$1.join(__dirname.replace('app.asar','app.asar.unpacked'),'../util/pyvisa/'),pythonOptions:['-m'],args:[this.host],mode:'text'});}catch(a){return clearTimeout(c), void b(a)}this.visaShell.once('error',a=>{a=a.toString('utf-8'), clearTimeout(c), b(a);}), this.visaShell.once('message',async b=>{b=b.toString('utf-8'), this.visaShell.removeAllListeners('error'), await this.command(':FORM:BORD SWAP'), await this.command(':FORM:DATA REAL,32'), await this.command(':FORM:ELEM VOLT,CURR'), await this.command('*rst; status:preset; *cls'), clearTimeout(c), a(b);}), this.visaShell.send('connect');})}delay(a){return new Promise(b=>{setTimeout(()=>{b();},a);})}command(a){return new Promise(b=>{this.visaShell.once('message',async a=>{a=a.toString('utf-8'), await this.delay(20), b(a);}), this.visaShell.send(a);})}query(a){return new Promise((b,c)=>{this.visaShell.once('message',async a=>(a=a.toString('utf-8'), await this.delay(20), -1<a.indexOf('ERROR')?void c(a):void b(a))), this.visaShell.send(a);})}async getIVTrace(){var a,b=Graph.newWaveform(),c=await this.query('TRAC:DATA?').then(c=>c.replace('[','').replace(']','').split(',').map(a=>parseFloat(a)).forEach((c,d)=>{0==d%2&&(a=c), 1==d%2&&b.append(a,c);})),d=b.duplicate().math((a,b)=>a*b);return{dataiv:b,poweriv:d}}}

const PythonShell$1=require('python-shell');
const path$2=require('path');class KeithleySMU$2{static list(){return new Promise((a,b)=>{var c=new PythonShell$1('script.list',{pythonOptions:['-m'],cwd:path$2.join(__dirname.replace('app.asar','app.asar.unpacked'),'../util/pyvisa/'),mode:'text'});c.once('error',a=>{a=a.toString('utf-8'), c.removeAllListeners('message'), b(a);}), c.once('message',d=>{d=d.toString('utf-8'), c.removeAllListeners('error'), Array.isArray(d)&&(d=d[0]);let e=/\((.*)\)/gim.exec(d);return e&&e[1]?0==e[1].length?void b():void(e=e[1].split(',').map(a=>(a=/u'(.*)'/g.exec(a), a&&a[1]?a[1]:null)), a(e)):b()});})}constructor(a){this.host=a;}connect(){return this.visaShell&&(this.visaShell.removeAllListeners('message'), this.visaShell.removeAllListeners('error'), this.visaShell=null), new Promise((a,b)=>{var c=setTimeout(()=>{this.visaShell.end(()=>{b('Cannot connect');});},1e3);try{this.visaShell=new PythonShell$1('script.iovisa',{cwd:path$2.join(__dirname.replace('app.asar','app.asar.unpacked'),'../util/pyvisa/'),pythonOptions:['-m'],args:[this.host],mode:'text'});}catch(a){return clearTimeout(c), void b(a)}this.visaShell.once('error',a=>{a=a.toString('utf-8'), clearTimeout(c), b(a);}), this.visaShell.once('message',async b=>{b=b.toString('utf-8'), this.visaShell.removeAllListeners('error'), clearTimeout(c), a(b);}), this.visaShell.send('connect');})}delay(a){return new Promise(b=>{setTimeout(()=>{b();},a);})}command(a){return new Promise(b=>{this.visaShell.once('message',async a=>{a=a.toString('utf-8'), await this.delay(20), b(a);}), this.visaShell.send(a);})}query(a){return new Promise((b,c)=>{this.visaShell.once('message',async a=>(a=a.toString('utf-8'), await this.delay(20), -1<a.indexOf('ERROR')?void c(a):void b(a))), this.visaShell.send(a);})}}

class FileBuilder{constructor(){this.waves=[];}addWaveform(a,b){this.waves.push({data:a,options:b});}}class ITXBuilder extends FileBuilder{constructor(){super(...arguments);}build(){let a="IGOR\n";return a+=this.waves.map(a=>this.buildWave(a.data,a.options)).join("\n"), a}buildWave(a,b){let c="";if(c+="WAVES/D\t'"+b.waveName+"'", a.hasXWaveform()&&!b.noXWave&&(c+=" '"+(b.waveNameX||b.waveName+"_x")+"'"), c+="\n", c+="BEGIN\n", a.hasXWaveform()&&!b.noXWave)for(var d=0,e=a.getLength();d<e;d++)c+=a.getY(d)+" "+a.getX(d)+"\n";else c+=a.getData().join("\n"), c+="\n";if(c+="END\n", !a.hasXWaveform()||a.hasXUnit()){let d="x SetScale/";d+=a.hasXWaveform()?"P 0, 1":"P x "+a.xOffset+","+a.xScale, d+=", \""+(a.getXUnit()||"")+"\"", d+=", '"+b.waveName+"'", d+="\n", c+=d;}return a.hasUnit()&&(c+="x SetScale y 0, 0,\""+(a.getUnit()||"")+"\", '"+b.waveName+"'\n"), c}}

function svgToPDF(a,b,c){return new Promise(d=>{var e=document.createElement('canvas');e.width=4*b, e.height=4*c;var f=e.getContext('2d'),g=window.URL||window.webkitURL||window,h=new Image,i=new Blob([a.innerHTML],{type:'image/svg+xml'}),j=g.createObjectURL(i);h.onload=function(){f.drawImage(h,0,0,4*b,4*c), d(e.toDataURL()), g.revokeObjectURL(j);}, h.src=j;})}

let getIVParameters=(a,b,c,d,e=!1)=>{let f,g;try{f=a.getY(a.getIndexFromX(0));}catch(a){f=NaN;}try{g=a.getX(a.findLevel(0));}catch(a){g=NaN;}let h=e?b.getMaxY():b.getMinY();let i=h/(f*g),j=Math.round(100*(100*(1e3*h/c/(d/10))))/100*(e?1:-1),k=b.findLevel(h),l=b.getX(k);return{isc:1e3*f*(e?1:-1),jsc:1e3*(f/c)*(e?1:-1),voc:g,ff:100*i,powerin:d,power:1e3*h,pce:j,jmax:0,vmax:l}};

const {dialog}=require("electron").remote;let iv_height=400; let iv_width=550;class MPPTJV extends React.Component{constructor(){super(...arguments), this.connectKeithleyToGPIB=this.connectKeithleyToGPIB.bind(this), this.connectLampToGPIB=this.connectLampToGPIB.bind(this), this.iv=this.iv.bind(this), this.mppt=this.mppt.bind(this), this.stop_mppt=this.stop_mppt.bind(this), this.form_iv_change=this.handleInputChange.bind(this), this.form_mppt_change=this.handleInputChange.bind(this), this.form_gpib_change=this.handleInputChange.bind(this), this.form_ext_change=this.handleInputChange.bind(this), this.downloadPDF=this.downloadPDF.bind(this), this.downloadITX=this.downloadITX.bind(this), this.downloadCSV=this.downloadCSV.bind(this), this.state={gpib_resources:[],iv_starting_voltage:1,iv_stopping_voltage:0,iv_hysteresis:0,iv_scan_rate:.1,mppt_duration:500,area:.5,powin:1e3,connected_keithley:!1,connected_lamp:!1};}async connectKeithleyToGPIB(){var a=this.state.gpib_resource_keithley;this.instrument=new KeithleySMU(a), this.instrument.connect().then(a=>{this.setState({connected_keithley:a,connectionerror_keithley:!1});}).catch(a=>{console.log(a), this.setState({connectionerror_keithley:a.toString(),connected_keithley:!1});});}async connectLampToGPIB(){var a=this.state.gpib_resource_lamp;this.instrument_lamp=new KeithleySMU$2(a), this.instrument_lamp.connect().then(a=>{this.setState({connected_lamp:a,connectionerror_lamp:!1});}).catch(a=>{console.log(a), this.setState({connectionerror_lamp:a.toString(),connected_lamp:!1});});}handleInputChange(a){const b=a.target,c="checkbox"===b.type?b.checked:b.value,d=b.name;this.setState({[d]:c}), this.getAverageIVParameters();}async downloadPDF(){var a=Math.round,b=new PDFDocument({autoFirstPage:!1});b.pipe(fs.createWriteStream("./output.pdf")), b.addPage({layout:"landscape"}), b.image((await svgToPDF(this.graph_iv_dom,iv_width,iv_height)),200,15,{width:iv_width}), this.state.mppt_j&&b.image((await svgToPDF(this.graph_mppt_dom,mppt_width,mppt_height)),200,150,{width:iv_width}), b.font("Times-Roman"), b.fontSize(15).text("Device name: "+this.state.samplename,0,15,{underline:!0}).fontSize(12).text("Active area: "+this.state.area.toPrecision(3)+"cm",0,35).moveUp().fontSize(8).text(2,120,35);((c,d,e,f)=>{var g=this.getIVParameters(c,d,this.state.area,this.state.powin);b.fontSize(14).text("Forward scan",0,f,{underline:!0}).fontSize(12).text("V",e,f+20).fontSize(8).moveUp().text("oc",8+e).fontSize(12).text("J",e).fontSize(8).moveUp().text("sc",6+e).fontSize(12).text("I",e).fontSize(8).moveUp().text("sc",6+e).fontSize(12).text("V",e).fontSize(8).moveUp().text("pmax",6+e).fontSize(12).text("I",e).fontSize(8).moveUp().text("pmax",8+e).fontSize(12).text("P",e).fontSize(8).moveUp().text("out",8+e).fontSize(12).text("FF",e).text("PCE",e), b.text(a(1e3*g.voc)/1e3+" V",e+35,f+20).text(a(100*g.isc)/100+" mA",e+35).fontSize(8).moveUp().text("-2",25+e+35-8).fontSize(12).text(a(100*g.jsc)/100+" mA cm",e+35).fontSize(8).moveUp().text("-2",25+e+35-8).fontSize(12).text(a(1e3*g.vmax)/1e3+"V",e+35).text(a(100*g.jmax)/100+"mA cm",e+35).fontSize(8).moveUp().text("-2",25+e+35-8).fontSize(12).text(a(100*g.power)/100+" mW cm",e+35).fontSize(8).moveUp().text("-2",25+e+35-8).fontSize(12).text(a(10*g.ff)/10+" %",e+35).text(a(100*g.pce)/100+" %",e+35);})(this.state.data_iv_forward,this.state.data_iv_forward_power,20,60), b.end();}downloadCSV(){}downloadITX(){var a;a=new ITXBuilder, this.state.data_iv_forward&&(a.addWaveform(this.state.data_iv_forward,{waveName:"Photocurrent_fw",waveNameX:"Photocurrent_fw_voltage"}), a.addWaveform(this.state.data_iv_forward_power,{waveName:"Power_fw",noXWave:!0})), this.state.data_iv_backward&&(a.addWaveform(this.state.data_iv_backward,{waveName:"Photocurrent_fw",waveNameX:"Photocurrent_fw_backward"}), a.addWaveform(this.state.data_iv_backward_power,{waveName:"Power_fw",noXWave:!0})), this.state.mppt_j&&(a.addWaveform(this.state.mppt_j,{waveName:"MPPT_current",waveNameX:"MPPT_Time_s"}), a.addWaveform(this.state.mppt_v,{waveName:"MPPT_voltage",noXWave:!0}), a.addWaveform(this.state.mppt_p,{waveName:"MPPT_voltage",noXWave:!0})), dialog.showSaveDialog({message:"Save the data for the cell \""+this.state.samplename+"\"",defaultPath:"~/"+this.state.samplename+".itx"},b=>{fs.writeFileSync(b,a.build());});}async iv(){if(!this.instrument)throw"Cannot initiate a j-V curve. No instrument is connected.";var a,b,c=(this.state.iv_stopping_voltage-this.state.iv_starting_voltage)/99;await this.instrument_lamp.command("AMPLitude 1"), await this.instrument_lamp.command("OUTput ON"), this.setState({iv_making:!0}), await this.instrument.command(":STAT:MEAS:ENAB 512; *SRE 1; *CLS"), await this.instrument.command(":FORM:ELEM VOLT,CURR"), await this.instrument.command(":SOUR:VOLT:MODE SWE"), await this.instrument.command(":SOUR:VOLT:START "+this.state.iv_starting_voltage+"; STOP "+this.state.iv_stopping_voltage+"; STEP "+c+""), await this.instrument.command(":TRAC:CLE"), await this.instrument.command(":TRAC:POIN 100;:TRIG:COUN 100"), await this.instrument.command(":TRAC:FEED:CONT NEXT"), await this.instrument.command(":SOUR:DEL 0.01"), await this.instrument.command(":SENS:CURR:PROT 0.1"), await this.instrument.command(":SENS:CURR:RANGE:UPP 0.1"), await this.instrument.command(":SENS:CURR:RANGE:AUTO 1"), await this.instrument.command(":OUTP:STAT ON"), await this.instrument.command(":INIT"), await this.instrument.delay(5e3), await this.instrument.query("_wait_stb"), {dataiv:a,poweriv:b}=await this.instrument.getIVTrace(), this.setState({data_iv_forward:a,data_iv_forward_power:b,data_iv_backward:null,data_iv_backward_power:null}), this.state.iv_hysteresis&&(await this.instrument.command(":STAT:MEAS:ENAB 512; *SRE 1; *CLS"), await this.instrument.command(":TRAC:CLE"), await this.instrument.command(":SOUR:VOLT:START "+this.state.iv_stopping_voltage+"; STOP "+this.state.iv_starting_voltage+"; STEP "+-c+""), await this.instrument.command(":TRAC:POIN 100;:TRIG:COUN 100"), await this.instrument.command(":TRAC:FEED:CONT NEXT"), await this.instrument.command(":INIT"), await this.instrument.delay(2e3), await this.instrument.query("_wait_stb"), {dataiv:a,poweriv:b}=await this.instrument.getIVTrace(), this.setState({data_iv_backward:a,data_iv_backward_power:b})), await this.instrument.command(":OUTP:STAT OFF"), await this.instrument_lamp.command("OUTput OFF"), this.getAverageIVParameters(), this.setState({iv_making:!1});}getAverageIVParameters(){var a=Math.round,b=this.getIVParameters(this.state.data_iv_forward,this.state.data_iv_forward_power);if(this.state.data_iv_backward){var c=this.getIVParameters(this.state.data_iv_backward,this.state.data_iv_backward_power);for(var d in c)b[d]=(c[d]+b[d])/2;}b.jsc=a(100*b.jsc)/100, b.voc=a(1e3*b.voc)/1e3, b.ff=a(10*b.ff)/10, b.pce=a(1e3*b.pce)/1e3, this.setState(b);}getIVParameters(a,b){return getIVParameters(a,b)}setVoltage(){this.instrument.command(":SOUR:VOLT:LEV:IMM:AMPL "+voltage);}async iv_prepare(a){await this.instrument.command("*CLS"), await this.instrument.command(":STAT:MEAS:ENAB 512"), await this.instrument.command(":TRAC:FEED:CONT NEVER"), await this.instrument.command(":TRAC:CLE"), await this.instrument.command("*SRE 1"), await this.instrument.command(":SOUR:VOLT:MODE SWE"), await this.instrument.command(":FORM:ELEM VOLT,CURR"), await this.instrument.command(":SENS:CURR:PROT "+(a/1e3).toPrecision(4));}async _iv(a,b,c){return await this.instrument.command("*CLS"), await this.instrument.command(":SOUR:VOLT:START "+a+"; STOP "+b+"; STEP "+(b-a)/(c-1)), await this.instrument.command(":TRAC:CLE; :TRAC:POIN "+c+";:TRIG:COUN "+c+"; :TRAC:FEED:CONT NEXT"), await this.instrument.command(":INIT"), await this.instrument.delay(10), await this.instrument.query("_wait_stb"), this.instrument.getIVTrace()}async mppt(){await this.instrument_lamp.command("AMPLitude 1"), await this.instrument_lamp.command("OUTput ON"), await this.instrument.command(":SOUR:DEL "+this.state.equilibration), await this.instrument.command(":OUTP:STAT ON"), this.iv_prepare(this.state.compliance), this.setState({running_mpp:!0}), await this.instrument.command(":SENS:CURR:PROT 0.1"), await this.instrument.command(":SENS:CURR:RANGE:UPP 0.1"), await this.instrument.command(":SENS:CURR:RANGE:AUTO 1"), await this.instrument.command(":OUTP:STAT ON");for(let d,e,f,g,h,i,j,k=Graph.newWaveform(),l=Graph.newWaveform(),m=Graph.newWaveform(),n=0,o=1,p=Date.now();;){for(e=Date.now(), d=n+5e-3*o, {dataiv:h,poweriv:i}=await this._iv(n,d,5), f=Date.now(), g=0;g<h.getLength();g++)j=(g*(f-e)/h.getLength()+e-p)/1e3, k.append(j,h.getY(g)), l.append(j,h.getX(g)), m.append(j,h.getY(g)*h.getX(g));var a=await m.fit({params:[0,0],subsetIndex:[m.getLength()-h.getLength(),m.getLength()-1],function:(a,b)=>(a-m.getX(m.getLength()-h.getLength()))*b[0]+b[1]}).then(a=>a[0]),b=100*(1e3*m.getMinY())/100,c=-Math.round(100*(100*(1e3*m.getMinY()/this.state.area/(this.state.powin/10))))/100;if(this.setState({mppt_v:l,mppt_j:k,mppt_p:m,mppt_max_power:b,mppt_max_efficiency:c}), 0<a&&(o*=-1), n=d, this.stopMPP){this.stopMPP=!1;break}if(e-p>1e3*this.state.mppt_duration)break}await this.instrument.command(":OUTP:STAT OFF"), await this.instrument_lamp.command("OUTput ON"), this.setState({running_mpp:!1});}stop_mppt(){this.stopMPP=!0;}componentDidMount(){this.graph_iv_instance=new Graph(this.graph_iv_dom), this.graph_iv_instance.resize(iv_width,iv_height), this.legend=this.graph_iv_instance.makeLegend({frame:!1,backgroundColor:"transparent"}), this.legend.setAutoPosition("bottom"), this.legend.notHideable(), this.graph_iv_instance.getLeftAxis().setUnit("A").setUnitWrapper("(",")").gridsOff().setUnitDecade(!0).setScientific(!0).setLabel("Current density"), this.graph_iv_instance.getBottomAxis().setUnit("V").setUnitWrapper("(",")").gridsOff().setLabel("Voltage"), this.graph_iv_instance.getRightAxis().setUnit("W").setUnitWrapper("(",")").setUnitDecade(!0).setScientific(!0).gridsOff().setLabel("Power"), this.graph_iv_instance.draw(), this.legend.update(), this.serie_iv_forward=this.graph_iv_instance.newSerie("iv-fw").setLabel("j(V) fw").autoAxis().setLineColor("blue"), this.serie_iv_backward=this.graph_iv_instance.newSerie("iv-bw").setLabel("j(V) bw").autoAxis().setLineColor("red"), this.serie_iv_forward_power=this.graph_iv_instance.newSerie("pow-fw").setLabel("P(V) fw").autoAxis().setYAxis(this.graph_iv_instance.getRightAxis()).setLineColor("blue").setLineStyle(2), this.serie_iv_backward_power=this.graph_iv_instance.newSerie("pow-bw").setLabel("P(V) bw").autoAxis().setYAxis(this.graph_iv_instance.getRightAxis()).setLineColor("red").setLineStyle(2), this.shape_mpp_backward=this.graph_iv_instance.newShape("ellipse").setR("3px","3px").setFillColor("black").draw().setSerie(this.serie_iv_backward_power), this.shape_mpp_forward=this.graph_iv_instance.newShape("ellipse").setR("3px","3px").setFillColor("black").draw().setSerie(this.serie_iv_forward_power), this.graph_mppt_instance=new Graph(this.graph_mppt_dom), this.graph_mppt_instance.resize(550,300), this.graph_mppt_instance.getLeftAxis(0).setUnit("A").setUnitWrapper("(",")").setUnitDecade(!0).setScientific(!0).gridsOff().setLabel("Current"), this.graph_mppt_instance.getLeftAxis(1).setUnit("V").setUnitWrapper("(",")").setUnitDecade(!0).setScientific(!0).gridsOff().setLabel("Voltage"), this.graph_mppt_instance.getLeftAxis(2).setUnit("W").setUnitWrapper("(",")").setUnitDecade(!0).setScientific(!0).gridsOff().setLabel("Power"), this.graph_mppt_instance.getBottomAxis().setUnit("s").setUnitWrapper("(",")").gridsOff().setLabel("Time"), this.graph_mppt_instance.getLeftAxis(0).setSpan(0,.3), this.graph_mppt_instance.getLeftAxis(1).setSpan(.35,.65), this.graph_mppt_instance.getLeftAxis(2).setSpan(.7,1), this.serie_mppt_j=this.graph_mppt_instance.newSerie("mppt_i").autoAxis().setYAxis(this.graph_mppt_instance.getLeftAxis(0)), this.serie_mppt_v=this.graph_mppt_instance.newSerie("mppt_v").autoAxis().setYAxis(this.graph_mppt_instance.getLeftAxis(1)), this.serie_mppt_p=this.graph_mppt_instance.newSerie("mppt_p").autoAxis().setYAxis(this.graph_mppt_instance.getLeftAxis(2)), this.graph_mppt_instance.autoscaleAxes().draw(), this.doListInstruments(), this.componentDidUpdate();}placeMaxPowerShape(a,b){if(b){if(!a)return void b.hide();let c=a.findLocalMinMaxIndex(0,a.getLength()-1,"min"),d=a.getY(a.getIndexFromX(c));b.show().setPosition({x:c,y:d}).redraw();}}componentDidUpdate(){this.graph_iv_instance&&this.graph_mppt_instance&&(this.state.data_iv_forward&&this.serie_iv_forward.setWaveform(this.state.data_iv_forward), this.state.data_iv_forward_power&&this.serie_iv_forward_power.setWaveform(this.state.data_iv_forward_power), this.placeMaxPowerShape(this.state.data_iv_forward_power,this.shape_mpp_forward), this.state.data_iv_backward&&this.serie_iv_backward.setWaveform(this.state.data_iv_backward), this.state.data_iv_backward_power&&this.serie_iv_backward_power.setWaveform(this.state.data_iv_backward_power), this.placeMaxPowerShape(this.state.data_iv_backward_power,this.shape_mpp_backward), this.graph_iv_instance.autoscaleAxes().draw(), this.legend.update(), this.graph_iv_instance.getLeftAxis().forceMax(-this.graph_iv_instance.getLeftAxis().getDataMin()), this.graph_iv_instance.getRightAxis().forceMax(-this.graph_iv_instance.getRightAxis().getDataMin()), this.state.mppt_p&&this.serie_mppt_p.setWaveform(this.state.mppt_p), this.state.mppt_j&&this.serie_mppt_j.setWaveform(this.state.mppt_j), this.state.mppt_v&&this.serie_mppt_v.setWaveform(this.state.mppt_v), this.graph_mppt_instance.autoscaleAxes().draw());}scheduleListInstruments(){setTimeout(()=>{this.doListInstruments();},5e3);}doListInstruments(){KeithleySMU.list().then(a=>{this.setState({gpib_resources:a}), this.scheduleListInstruments();}).catch(()=>{this.scheduleListInstruments();});}render(){let a=[];for(var b=0;b<this.state.gpib_resources.length;b++)a.push(React.createElement("option",{value:this.state.gpib_resources[b],key:this.state.gpib_resources[b]},this.state.gpib_resources[b]));return React.createElement("div",{className:"container-fluid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col-xs-2"},React.createElement("div",{className:"container-fluid"},React.createElement("h3",null,"j(V) and MPP tracker"),React.createElement("form",null,React.createElement("div",{className:"form-group row"},React.createElement("label",{htmlFor:"gpib_resource"},"Keithley GPIB resource"),React.createElement("div",{className:"input-group"},React.createElement("select",{name:"gpibresource",id:"gpib_resource_keithley",name:"gpib_resource_keithley",className:"form-control",value:this.state.gpib_resource_keithley,onChange:this.form_gpib_change},React.createElement("option",{value:"-1"},"Select the Keithley"),a),React.createElement("div",{className:"input-group-btn"},React.createElement("button",{type:"button",className:"btn btn-primary",onClick:this.connectKeithleyToGPIB},"Connect")))),this.state.connectionerror_keithley&&React.createElement("p",{className:"bg-danger"},"Problem connecting to GPIB resource. Check Keithley parameters. The returned error was : ",this.state.connectionerror," "),this.state.connected_keithley&&React.createElement("p",{className:"bg-success"},"Successfully connected to remote host (IDN ",this.state.connected_keithley,")"),React.createElement("div",{className:"form-group row"},React.createElement("label",{htmlFor:"gpib_resource"},"Verasol GPIB resource"),React.createElement("div",{className:"input-group"},React.createElement("select",{name:"gpibresource",id:"gpib_resource_lamp",name:"gpib_resource_lamp",className:"form-control",value:this.state.gpib_resource_lamp,onChange:this.form_gpib_change},React.createElement("option",{value:"-1"},"Select the Verasol lamp"),a),React.createElement("div",{className:"input-group-btn"},React.createElement("button",{type:"button",className:"btn btn-primary",onClick:this.connectLampToGPIB},"Connect")))),this.state.connectionerror_lamp&&React.createElement("p",{className:"bg-danger"},"Problem connecting to GPIB resource. Check Verasol parameters. The returned error was : ",this.state.connectionerror," "),this.state.connected_lamp&&React.createElement("p",{className:"bg-success"},"Successfully connected to remote host (IDN ",this.state.connected_lamp,")")),React.createElement("form",null,React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Sample name"),React.createElement("input",{type:"text",className:"form-control",name:"samplename",value:this.state.samplename,onChange:this.form_ext_change})),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Light intensity"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"powin",value:this.state.powin,onChange:this.form_ext_change}),React.createElement("span",{className:"input-group-addon"},"W m",React.createElement("sup",null,"-2")))),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Device area"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"area",value:this.state.area,onChange:this.form_ext_change}),React.createElement("span",{className:"input-group-addon"},"cm",React.createElement("sup",null,"-2"))))),React.createElement("form",null,React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Starting voltage"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"iv_starting_voltage",value:this.state.iv_starting_voltage,onChange:this.form_iv_change}),React.createElement("span",{className:"input-group-addon"},"V"))),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Stopping voltage"),React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"iv_stopping_voltage",value:this.state.iv_stopping_voltage,onChange:this.form_iv_change}),React.createElement("span",{className:"input-group-addon"},"V"))),React.createElement("div",{className:"form-group row"},React.createElement("div",{className:"checkbox"},React.createElement("div",{className:"checkbox"},React.createElement("label",null,React.createElement("input",{type:"checkbox",name:"iv_hysteresis",value:this.state.iv_hysteresis,onChange:this.form_iv_change})," Hysteresis")))),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Scan rate"),React.createElement("div",null,React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"iv_scan_rate",type:"number",max:"1",min:"0.0001",step:"0.0001",value:this.state.iv_scan_rate,onChange:this.form_iv_change}),React.createElement("span",{className:"input-group-addon"},"V s",React.createElement("sup",null,"-1"))))),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Current compliance"),React.createElement("div",null,React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"compliance",type:"number",max:"1000",min:"0",step:"10",value:this.state.compliance,onChange:this.form_iv_change}),React.createElement("span",{className:"input-group-addon"},"mA")))),React.createElement("div",{className:"form-group row"},React.createElement("label",null,"Equilibration time"),React.createElement("div",null,React.createElement("div",{className:"input-group"},React.createElement("input",{type:"number",className:"form-control",name:"equilibration",type:"number",max:"100",min:"0",step:"0.5",value:this.state.equilibration,onChange:this.form_iv_change}),React.createElement("span",{className:"input-group-addon"},"s"))))),React.createElement("form",null,React.createElement("div",{className:"form-group row"},React.createElement("label",null,"MPPT duration"),React.createElement("div",{className:"input-group"},React.createElement("input",{className:"form-control",name:"mppt_duration",type:"number",max:"1000",min:"10",step:"1",value:this.state.mppt_duration,onChange:this.form_mppt_change}),React.createElement("span",{className:"input-group-addon"},"s")))),React.createElement("div",{className:"row"},React.createElement("div",{className:"btn-group form-group"},React.createElement("button",{onClick:this.iv,className:"btn btn-primary"+(!this.state.iv_making&&this.state.connected_keithley&&this.state.connected_lamp?"":" disabled"),type:"button"},React.createElement("span",{className:"glyphicon glyphicon-record"})," Record IV"),!this.state.running_mpp&&React.createElement("button",{onClick:this.mppt,className:"btn btn-primary"+(this.state.connected_keithley&&this.state.connected_lamp?"":" disabled"),type:"button"},React.createElement("span",{className:"glyphicon glyphicon-record"})," Record MPP"),!!this.state.running_mpp&&React.createElement("button",{onClick:this.stop_mppt,className:"btn btn-danger",type:"button"},React.createElement("span",{className:"glyphicon glyphicon-stop"})," Stop MPP"),React.createElement("div",{className:"clearfix visible-xs-block"}))),React.createElement("div",{className:"row"},React.createElement("div",{className:"btn-group form-group"},React.createElement("button",{onClick:this.downloadITX,className:"btn btn-default",type:"button"},React.createElement("span",{className:"glyphicon glyphicon-download"})," Download ITX")),React.createElement("div",{className:"clearfix visible-xs-block"})))),React.createElement("div",{className:"col-xs-4"},React.createElement("div",{className:"row"},React.createElement("div",{className:"graph",ref:a=>{this.graph_iv_dom=a;}})),React.createElement("div",{className:"row"},React.createElement("div",{className:"graph",ref:a=>{this.graph_mppt_dom=a;}}))),React.createElement("div",{className:"col-xs-3"},React.createElement("h3",null,"Extracted data"),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-addon"},"J",React.createElement("sub",null,"sc")),React.createElement("input",{type:"text",className:"form-control",readOnly:!0,value:this.state.jsc}),React.createElement("span",{className:"input-group-addon"},"mA cm",React.createElement("sup",null,"-2")))),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-addon"},"V",React.createElement("sub",null,"oc")),React.createElement("input",{type:"text",className:"form-control",readOnly:!0,value:this.state.voc}),React.createElement("span",{className:"input-group-addon"},"V"))),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-addon"},"FF"),React.createElement("input",{type:"number",max:"100",step:"0.1",className:"form-control",readOnly:!0,value:this.state.ff}),React.createElement("span",{className:"input-group-addon"},"%"))),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-addon"},"PCE"),React.createElement("input",{type:"number",min:"0",max:"35",step:"0.01",className:"form-control",readOnly:!0,value:this.state.pce}),React.createElement("span",{className:"input-group-addon"},"%"))),React.createElement("div",{className:"form-group"},React.createElement("div",{className:"input-group"},React.createElement("span",{className:"input-group-addon"},"MPPT PCE"),React.createElement("input",{type:"text",className:"form-control",readOnly:!0,value:this.state.mppt_max_efficiency}),React.createElement("span",{className:"input-group-addon"},"%"))))))}}

function render(){ReactDOM.render(React.createElement('div',null,React.createElement(MPPTJV,{model:'keithley2400'})),document.getElementById('root'));}render();

//# sourceMappingURL=mppt.js.map