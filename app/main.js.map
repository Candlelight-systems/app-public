{"version":3,"sources":["../source/main.js"],"names":["electron","require","Menu","ipcMain","dialog","app","BrowserWindow","path","url","fs","request","fix","fetch","WebSocket","environment","currentInstrument","configPath","join","__dirname","replace","config","JSON","parse","readFileSync","windows","on","addInstrument","editInstrument","removeInstrument","loadInstrument","editInfluxDB","updateInfluxDB","downloadData","htmlReport","configChannel","configChannels","openMPPT","openBugReport","openCalibratePD","openCalibratePyranometer","openScheduleLight","reportError","makeInstrumentMenu","label","submenu","click","showAllMeasurements","type","accelerator","selector","instruments","map","trackerName","checked","trackerHost","openSocket","trackerPortWS","console","log","setTimeout","code","wsIncoming","isAlive","setInterval","terminate","readyState","CLOSED","clearInterval","ping","instrumentId","chanId","webContents","send","groupName","doMenu","ageing","push","unshift","getName","role","buildFromTemplate","setApplicationMenu","saveConfig","Promise","writeFile","stringify","createMainWindow","width","height","resizable","once","database","loadURL","format","pathname","protocol","slashes","platform","quit","trackerPort","method","then","json","catch","Error","openForm","measurementName","db","cellInfo","reloadInstruments","showSaveDialog","message","cellName","defaultPath","printToPDF","marginsType","pageSize","landscape","x","y","center","removeListener","showMessageBox","cancelId","defaultId","title","buttons","forEach","splice","toString","host","mode","close","isLoading","tracker","Object","assign","status","instrument","error","options","form","configDB","all","post","timeout","instrumentConfig","channelConfig","channelState","channels","sender","chanIds","channelsState","channelIds","windowForm","_rejecter"],"mappings":"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","file":"main.js","sourcesContent":["const electron = require('electron')\r\nconst {Menu,ipcMain,dialog} = require('electron')\r\n// Module to control application life.\r\nconst app = electron.app\r\n// Module to create native browser window.\r\nconst BrowserWindow = electron.BrowserWindow\r\n\r\nconst path = require('path')\r\nconst url = require('url')\r\nconst fs = require('fs');\r\nconst request = require('request-promise-native');\r\nconst fix = require( 'fix-path' );\r\nconst fetch = require( 'node-fetch' );\r\nconst WebSocket = require( 'ws' );\r\nconst environment = require(\"./environment.json\");\r\n\r\nfix();\r\n\r\nlet currentInstrument;\r\n\r\nconst configPath = path.join( __dirname.replace(\"app.asar\", \"app.asar.unpacked\" ), '/config.json' );\r\nlet config = JSON.parse( fs.readFileSync( configPath ) );\r\n\r\nlet windows = {};\r\n\r\nipcMain.on(\"addInstrument\", addInstrument );\r\nipcMain.on(\"editInstrument\", editInstrument );\r\nipcMain.on(\"removeInstrument\", removeInstrument );\r\nipcMain.on(\"loadInstrument\", loadInstrument );\r\n\r\nipcMain.on(\"editInfluxDB\", editInfluxDB );\r\nipcMain.on(\"updateInfluxDB\", updateInfluxDB );\r\nipcMain.on(\"downloadData\", downloadData );\r\nipcMain.on(\"htmlReport\", htmlReport );\r\n\r\nipcMain.on(\"configChannel\", configChannel );\r\nipcMain.on(\"configChannels\", configChannels );\r\nipcMain.on(\"mppt\", openMPPT );\r\nipcMain.on(\"bugReport\", openBugReport );\r\nipcMain.on(\"calibratePD\", openCalibratePD );\r\nipcMain.on(\"calibratePyranometer\", openCalibratePyranometer );\r\nipcMain.on(\"scheduleLight\", openScheduleLight );\r\n\r\nipcMain.on(\"reportError\", reportError );\r\n\r\n\r\nfunction makeInstrumentMenu() {\r\n  return {\r\n    label: 'Instrument',\r\n    submenu: [\r\n      { label: 'Add a new instrument', click() { addInstrument(); } },\r\n      { label: 'Edit instrument', click() { editInstrument( currentInstrument ); } },\r\n      { label: 'Edit database config', click() { editInfluxDB( ); } },\r\n      { label: 'Show all measurements', click() { showAllMeasurements( currentInstrument ); } },\r\n      { type: 'separator' },\r\n      { label: \"Cut\", accelerator: \"CmdOrCtrl+X\", selector: \"cut:\" },\r\n      { label: \"Copy\", accelerator: \"CmdOrCtrl+C\", selector: \"copy:\" },\r\n      { label: \"Paste\", accelerator: \"CmdOrCtrl+V\", selector: \"paste:\" },\r\n\r\n      ...config.instruments.map( (instrument) => {\r\n        return { label: instrument.trackerName, checked: currentInstrument == instrument.trackerHost, click( event ) { loadInstrument( event, instrument.trackerHost ) } }\r\n      } )\r\n    ]\r\n  };\r\n}\r\n\r\nfunction openSocket( instrumentConfig ) {\r\n\r\n  const ws = new WebSocket('ws://' + instrumentConfig.trackerHost + ':' + instrumentConfig.trackerPortWS );\r\n  \r\n  ws.on('open', function open() {\r\n    console.log(\"Socket is open\");\r\n  });\r\n\r\n  ws.on('close', function open() {\r\n    console.log(\"Socket is closed\");\r\n    setTimeout( () => openSocket( instrumentConfig ), 1000 );\r\n  });\r\n\r\n  ws.on('error', function error( err ) {\r\n    console.log(\"Socket is in error state: \" + error.code );\r\n  });\r\n\r\n\r\n  ws.on('message', wsIncoming );\r\n\r\n  ws.isAlive = true;\r\n  ws.on('pong', () => ws.isAlive = true );\r\n\r\n  var socketTimeout = () => {\r\n\r\n    let interval = setInterval( () => {\r\n\r\n      if( !ws.isAlive ) {\r\n        ws.terminate();\r\n      }\r\n\r\n      if( ws.readyState == WebSocket.CLOSED ) {\r\n        clearInterval( interval );\r\n      }\r\n\r\n      ws.isAlive = false;\r\n      ws.ping( '', false, true );\r\n\r\n    }, 30000 );\r\n  }\r\n\r\n  socketTimeout();\r\n}\r\n\r\n\r\n\r\nfunction wsIncoming( data ) {\r\n\r\n  data = JSON.parse( data );\r\n\r\n  if( data.instrumentId && windows[ 'instrumentMain' ]) {\r\n\r\n    if( data.chanId ) {\r\n      windows[ 'instrumentMain' ].webContents.send( \"channel.update.\" + data.instrumentId + \".\" + data.chanId, data ); \r\n    }\r\n\r\n    if( data.groupName ) {\r\n      \r\n      windows[ 'instrumentMain' ].webContents.send( \"group.update.\" + data.instrumentId + \".\" + data.groupName, data ); \r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\nfunction doMenu() {\r\n  //require(\"./menu\");\r\n  const template = [\r\n  ];\r\n\r\n  if( environment.ageing ) {\r\n    template.push( makeInstrumentMenu() );\r\n  }\r\n\r\n  //if (process.platform === 'darwin') {\r\n    template.unshift({\r\n      label: app.getName(),\r\n      submenu: [\r\n        {role: 'about'},\r\n        {type: 'separator'},\r\n        {role: 'services', submenu: []},\r\n        {type: 'separator'},\r\n        {role: 'hide'},\r\n        {role: 'hideothers'},\r\n        {role: 'unhide'},\r\n        {type: 'separator'},\r\n        {role: 'quit'},\r\n      ]\r\n    });\r\n\r\n    if( process.env.NODE_ENV == 'development' ) {\r\n      template[ 0 ].submenu.push( {role: 'toggledevtools'} )\r\n    }\r\n  //}\r\n\r\n  const menu = Menu.buildFromTemplate(template);\r\n  Menu.setApplicationMenu(menu);\r\n}\r\n\r\nfunction saveConfig( ) {\r\n  \r\n  return new Promise( ( resolver, rejecter ) => {\r\n\r\n    fs.writeFile( configPath, JSON.stringify( config, undefined, \"\\t\" ), ( error ) => {\r\n\r\n      if( error ) {\r\n        reportError( error );\r\n        rejecter( error );\r\n      } else {\r\n        config = JSON.parse( fs.readFileSync( configPath ) );    \r\n        resolver( );\r\n      }\r\n      \r\n    });  \r\n  })  \r\n   \r\n}\r\n\r\n// Keep a global reference of the window object, if you don't, the window will\r\n// be closed automatically when the JavaScript object is garbage collected.\r\n\r\nfunction createMainWindow() {\r\n  // Create the browser window.\r\n  windows[ 'instrumentList' ] = new BrowserWindow({ width: 800, height: 700, resizable: false })\r\n\r\n  windows[ 'instrumentList' ].webContents.once(\"dom-ready\", () => {\r\n    windows[ 'instrumentList' ].webContents.send(\"dbInformation\", config.database );\r\n  });\r\n\r\n  // and load the index.html of the app.\r\n  windows[ 'instrumentList' ].loadURL(url.format({\r\n    pathname: path.join(__dirname, 'app/instrumentlist.html'),\r\n    protocol: 'file:',\r\n    slashes: true\r\n  }))\r\n\r\n  // Open the DevTools.\r\n  // windows[ 'instrumentList' ].webContents.openDevTools()\r\n\r\n  // Emitted when the window is closed.\r\n  windows[ 'instrumentList' ].on('closed', function () {\r\n    // Dereference the window object, usually you would store windows\r\n    // in an array if your app supports multi windows, this is the time\r\n    // when you should delete the corresponding element.\r\n    windows[ 'instrumentList' ] = null\r\n  });\r\n\r\n\r\n\r\n  doMenu();\r\n}\r\n\r\n// This method will be called when Electron has finished\r\n// initialization and is ready to create browser windows.\r\n// Some APIs can only be used after this event occurs.\r\napp.on('ready', createMainWindow )\r\n\r\n// Quit when all windows are closed.\r\napp.on('window-all-closed', function () {\r\n  // On OS X it is common for applications and their menu bar\r\n  // to stay active until the user quits explicitly with Cmd + Q\r\n  if (process.platform !== 'darwin') {\r\n    app.quit()\r\n  }\r\n})\r\n\r\napp.on('activate', function () {\r\n  // On OS X it's common to re-create a window in the app when the\r\n  // dock icon is clicked and there are no other windows open.\r\n  if (windows[ 'instrumentList' ] === null) {\r\n    createMainWindow()\r\n  }\r\n})\r\n\r\nasync function downloadData( event, tracker, measurementName, chanId ) {\r\n\r\n    let json = await fetch( `http://${ tracker.trackerHost }:${ tracker.trackerPort }/getMeasurement?measurementName=${ measurementName }`, {\r\n      method: 'GET'\r\n    })\r\n    .then( ( response ) => response.json() )\r\n    .catch( () => {\r\n\r\n      throw new Error(`Error while connecting to the instrument. Check that you are online and that the instrument is available on your network.`);\r\n    });\r\n\r\n    openForm( null, \"downloadform\", { \r\n    \r\n      measurementName: measurementName, \r\n      db: config.database, \r\n      cellInfo: json.cellInfo, \r\n      chanId: chanId \r\n    \r\n    }, {\r\n        width: 850,\r\n        height: 800,\r\n        resizable: false\r\n\r\n      } ).then( async ( result ) => {\r\n      \r\n        config.instruments.push( result );\r\n        await saveConfig();\r\n        reloadInstruments();\r\n\r\n      } ).catch( () => {} );\r\n}\r\n\r\n\r\n\r\nfunction htmlReport( event, cellInfo, chanId, measurementName ) {\r\n\r\n    let listenerConfig, listenerSavePDF/*, listenerPrintPDF*/;\r\n\r\n    ipcMain.on(\"htmlReport.config\", ( listenerConfig = ( event, data ) => {\r\n      \r\n      if( ! windows[ 'htmlReport' ] ) {\r\n        return;\r\n      }\r\n\r\n      windows[ \"htmlReport\"].webContents.send( \"config\", data );\r\n    } ) );\r\n\r\n    ipcMain.on(\"htmlReport.savePDF\", ( listenerSavePDF = ( event, data ) => {\r\n      \r\n      if( ! windows[ 'htmlReport' ] ) {\r\n        return;\r\n      }\r\n\r\n\r\n      dialog.showSaveDialog( {\r\n\r\n        message: \"Save the report for device \" + data.cellName,\r\n        defaultPath: \"~/\" + data.cellName + \".pdf\"\r\n\r\n      }, ( fileName ) => {\r\n\r\n        windows[ 'htmlReport' ].webContents.printToPDF( {\r\n          marginsType: 1,\r\n          pageSize: 'A4',\r\n          landscape: true\r\n        }, ( err, data ) => {\r\n\r\n          fs.writeFile( fileName, data, ( error ) => {\r\n            console.log( err );  \r\n          } );\r\n        } );\r\n\r\n      } );\r\n        \r\n      //windows[ \"htmlReport\"].webContents.send( \"savePDF\", data );\r\n    } ) );\r\n\r\n/*\r\n\r\n    ipcMain.on(\"htmlReport.printPDF\", ( listenerPrintPDF = ( event, data ) => {\r\n      \r\n      if( ! windows[ 'htmlReport' ] ) {\r\n        return;\r\n      }\r\n\r\n        windows[ 'htmlReport' ].webContents.print( {\r\n          marginsType: 1,\r\n          pageSize: 'A4',\r\n          landscape: true\r\n        }, ( err, data ) => {\r\n\r\n          fs.writeFile( fileName, data, ( error ) => {\r\n            console.log( err );  \r\n          } );\r\n        } );\r\n        \r\n      //windows[ \"htmlReport\"].webContents.send( \"savePDF\", data );\r\n    } ) );\r\n*/\r\n    openForm( null, \"htmlreport_control\", { \r\n      measurementName: measurementName, \r\n      db: config.database, \r\n      cellInfo: cellInfo, \r\n      chanId: chanId \r\n    },   {\r\n      \r\n      width: 400,\r\n      height: 595,\r\n      x: 50,\r\n      y: 100,\r\n      center: false,\r\n      resizable: false\r\n\r\n    }, () => {\r\n\r\n        ipcMain.removeListener( \"htmlReport.config\", listenerConfig );\r\n        ipcMain.removeListener( \"htmlReport.savePDF\", listenerSavePDF );\r\n   //     ipcMain.removeListener( \"htmlReport.printPDF\", listenerPrintPDF );\r\n    } );\r\n\r\n    windows[ 'htmlReport' ] = new BrowserWindow( {\r\n      width: 1122, \r\n      height: 795, \r\n      x: 500, \r\n      y: 100, \r\n      center: false,\r\n      resizable: false\r\n    } )\r\n  \r\n\r\n    windows[ 'htmlReport' ].webContents.once(\"dom-ready\", () => {\r\n      windows[ 'htmlReport' ].webContents.send(\"loadData\", { measurementName: measurementName, db: config.database, cellInfo: cellInfo, chanId: chanId } );\r\n    });     \r\n      // and load the index.html of the app.\r\n    windows[ 'htmlReport' ].loadURL( url.format({\r\n      pathname: path.join(__dirname, 'app/htmlreport.html'),\r\n      protocol: 'file:',\r\n      slashes: true\r\n    }) );\r\n}\r\n\r\n\r\n\r\n\r\n\r\nfunction openBugReport( event ) {\r\n\r\n    openForm( null, \"bugreport\", {  },   {\r\n      width: 540,\r\n      height: 600,\r\n      resizable: false\r\n\r\n    } );\r\n}\r\n\r\n\r\nfunction openMPPT( keithleyModel ) {\r\n\r\n    windows[ 'mppt' ] = new BrowserWindow({width: 1400, height: 1024, center: true, resizable: false })\r\n      // and load the index.html of the app.\r\n    windows[ 'mppt' ].loadURL(url.format({\r\n      pathname: path.join(__dirname, 'app/mppt.html'),\r\n      protocol: 'file:',\r\n      slashes: true\r\n    }));\r\n}\r\n\r\n\r\nasync function openCalibratePD( event, data ) {\r\n\r\n  openForm( null, \"calibratepd\", { instrumentId: data.instrumentId, groupName: data.groupName, config: data.config }, {\r\n    width: 800,\r\n    height: 600,\r\n    resizable: false\r\n  }, async () => {\r\n\r\n    var channelConfig = await fetch( \"http://\" + data.config.trackerHost + \":\" + data.config.trackerPort + \"/resetAllChannels?instrumentId=\" + data.instrumentId + \"&groupName=\" + data.groupName, { method: 'GET' } ).then( ( response ) => response.json() );\r\n  } );\r\n}\r\n\r\n\r\nasync function openCalibratePyranometer( event, data ) {\r\n\r\n  openForm( null, \"calibratepyranometer\", { instrumentId: data.instrumentId, groupName: data.groupName, config: data.config }, {\r\n    width: 800,\r\n    height: 600,\r\n    resizable: false\r\n  }, async () => {\r\n\r\n    //var channelConfig = await fetch( \"http://\" + data.config.trackerHost + \":\" + data.config.trackerPort + \"/resetAllChannels?instrumentId=\" + data.instrumentId + \"&groupName=\" + data.groupName, { method: 'GET' } ).then( ( response ) => response.json() );\r\n  } );\r\n}\r\n\r\n\r\nasync function openScheduleLight( event, data ) {\r\n\r\n\r\n  //await fetch( \"http://\" + data.config.trackerHost + \":\" +   data.config.trackerPort + \"/light.pause?instrumentId=\" + data.instrumentId, { method: 'GET' } );\r\n  \r\n\r\n  // Once the light has been updated, send the information to the main window for update\r\n  let listener;\r\n  ipcMain.on(\"light.updated\", (  listener = () => {\r\n    windows[ \"instrumentMain\"].webContents.send( \"light.updated\" );\r\n  } ) );\r\n\r\n  openForm( null, \"scheduleLight\", { instrumentId: data.instrumentId, groupName: data.groupName, config: data.config }, {\r\n    width: 800,\r\n    height: 600,\r\n    resizable: false\r\n  }, function() {\r\n\r\n    // After the window is closed, remove the listener\r\n    ipcMain.removeListener( \"light.updated\", listener );\r\n//  await fetch( \"http://\" + data.config.trackerHost + \":\" + data.config.trackerPort + \"/light.resume?instrumentId=\" + data.instrumentId, { method: 'GET' } );\r\n\r\n  } );\r\n}\r\n\r\n\r\n\r\n\r\n// In this file you can include the rest of your app's specific main process\r\n// code. You can also put them in separate files and require them here.\r\n\r\nfunction removeInstrument( event, trackerHost ) {\r\n\r\n  dialog.showMessageBox( {\r\n    type: 'question',\r\n    message: 'Are you sure that you want to remove this instrument ?',\r\n    cancelId: 0,\r\n    defaultId: 0,\r\n    title: \"Remove the instrument\",\r\n    buttons: [ \"Cancel\", \"Yes\" ]    \r\n  }, async ( index ) => {\r\n\r\n    if( index == 1 ) {\r\n\r\n      config.instruments.forEach( ( instrument, index ) => {\r\n\r\n        if( instrument.trackerHost == trackerHost ) {\r\n          config.instruments.splice( index, 1 );\r\n        }\r\n\r\n      } );\r\n\r\n      await saveConfig();\r\n      reloadInstruments();\r\n    }\r\n\r\n  } );\r\n}\r\n\r\nfunction reportError( e ) {\r\n\r\n  console.log('Error reporting !');\r\n  dialog.showMessageBox( {\r\n    type: 'error',\r\n    message: 'An error has happened: ' + e.toString(),\r\n    cancelId: 0,\r\n    defaultId: 0,\r\n    title: \"Error\",\r\n    buttons: [ \"Ok\" ]    \r\n  }, ( index ) => {\r\n\r\n  } );\r\n}\r\n\r\nfunction reloadInstruments() {\r\n  windows[ 'instrumentList' ].webContents.send(\"reloadInstruments\");\r\n  doMenu();\r\n}\r\n\r\nfunction addInstrument() {\r\n\r\n  openForm( null, \"instrumentform\", {},   {\r\n    width: 850,\r\n    height: 800,\r\n    resizable: false\r\n\r\n  } ).then( async ( result ) => {\r\n    \r\n    try {\r\n      config.instruments.push( result );\r\n      await saveConfig();\r\n      reloadInstruments();\r\n    } catch( e ) {\r\n      reportError( e );\r\n    }\r\n\r\n\r\n  }).catch( () => {} );\r\n\r\n}\r\n\r\nfunction loadInstrument( event, tracker ) {\r\n\r\n  const trackerHost = tracker.host;\r\n  const mode = tracker.mode;\r\n\r\n\r\n  if( ! windows[ 'instrumentMain' ] ) {\r\n    // Create the browser window.\r\n    windows[ 'instrumentMain' ] = new BrowserWindow({width: 1400, height: 1024, center: true, resizable: false})\r\n\r\n\r\n  }\r\n\r\n  switch( mode ) {\r\n\r\n    case 'ageing':\r\n\r\n       windows[ 'instrumentMain' ].loadURL(url.format({\r\n        pathname: path.join(__dirname, 'app/instrument.html'),\r\n        protocol: 'file:',\r\n        slashes: true\r\n      }));\r\n    break;\r\n\r\n    case 'measurement':\r\n\r\n      windows[ 'instrumentMain' ].loadURL(url.format({\r\n        pathname: path.join(__dirname, 'app/instrument.html'),\r\n        protocol: 'file:',\r\n        slashes: true\r\n      } ) );\r\n\r\n    break;\r\n  }\r\n  \r\n  if( windows[ 'instrumentList' ] ) {\r\n    windows[ 'instrumentList' ].close();\r\n  }\r\n\r\n  let instrumentConfig;\r\n\r\n  config.instruments.forEach( ( instrument, index ) => {\r\n\r\n    if( instrument.trackerHost == trackerHost ) {\r\n      instrumentConfig = instrument;\r\n      currentInstrument = instrument;\r\n    }\r\n  });\r\n\r\n  // Global\r\n  \r\n\r\n\r\n  if( windows[ 'instrumentMain' ].webContents.isLoading() ) {\r\n\r\n    windows[ 'instrumentMain' ].webContents.once(\"dom-ready\", () => {  \r\n      windows[ 'instrumentMain' ].webContents.send( \"loadInstrument\", { tracker: instrumentConfig, db: config.database } );  \r\n    });\r\n    \r\n  } else {\r\n\r\n      windows[ 'instrumentMain' ].webContents.send( \"loadInstrument\", { tracker: instrumentConfig, db: config.database } );  \r\n  }\r\n  \r\n  windows[ 'instrumentMain' ].once(\"close\", () => {\r\n    windows[ 'instrumentMain' ] = null;\r\n  });\r\n  \r\n  openSocket( instrumentConfig );\r\n}\r\n\r\nfunction editInstrument( event, trackerHost ) {\r\n\r\n  let data;\r\n\r\n  config.instruments.forEach( ( instrument, index ) => {\r\n\r\n    if( instrument.trackerHost == trackerHost ) {\r\n      data = instrument;\r\n    }\r\n\r\n  } );\r\n\r\n  if( ! data ) {\r\n    throw \"Could not find the data corresponding to this instrument\";\r\n  }\r\n\r\n  openForm( null, \"instrumentform\", data, {\r\n    width: 600,\r\n    height: 800,\r\n    resizable: false\r\n\r\n  }  ).then( async ( results ) => {\r\n\r\n    Object.assign( data, results );\r\n    await saveConfig();\r\n\r\n    if( windows[ 'instrumentMain' ] ) {\r\n      windows[ 'instrumentMain' ].webContents.send( \"loadInstrument\", { tracker: data, db: config.database } ); \r\n    }\r\n    \r\n    if( windows[ 'instrumentList' ] ) {\r\n      windows[ 'instrumentList' ].webContents.send( \"instrumentUpdated\" ); \r\n    }\r\n    \r\n    reloadInstruments();\r\n\r\n  } ).catch( () => {} );\r\n}\r\n\r\n\r\n\r\n\r\nfunction editInfluxDB( event ) {\r\n\r\n  let data;\r\n  let influxConfig = config.database;\r\n\r\n  openForm( null, \"influxdbform\", influxConfig, { width: 600, height: 700, resizable: false } ).then( async ( results ) => {\r\n\r\n    config.database = results;\r\n    saveConfig();\r\n\r\n    windows[ 'form' ].webContents.send(\"uploading\", { status: 'progress', host: config.instruments.map( ( i ) => i.trackerHost ).join(', ') } );\r\n\r\n    updateInfluxDB( ).then( () => {\r\n      windows[ 'form' ].webContents.send(\"uploading\", {Â status: 'done', host: instrument.trackerHost } );\r\n    } ).catch( err => {\r\n      windows[ 'form' ].webContents.send(\"uploading\", { status: 'error', error: err, host: err.options.form.host } );\r\n    });\r\n\r\n    if( windows[ 'instrumentMain' ] ) {\r\n      windows[ 'instrumentMain' ].webContents.send( \"reloadDB\", { db: config.database } ); \r\n    }\r\n    \r\n  } ).catch( () => {} );\r\n}\r\n\r\nfunction showAllMeasurements( instrument ) {\r\n  \r\n  openForm( null, \"showallmeasurements\", { config: instrument, configDB: config.database }, { width: 600, height: 700, resizable: false } ).then( ( results ) => {\r\n\r\n  } ).catch( () => {} );\r\n}\r\n\r\n\r\nfunction updateInfluxDB( ) {\r\n\r\n  return Promise.all( config.instruments.map( ( instrument ) => {\r\n       return request.post( { url: \"http://\" + instrument.trackerHost + \":\" + instrument.trackerPort + \"/setInfluxDB\", form: config.database, timeout: 1000 } );\r\n  }  ) );\r\n}\r\n\r\n\r\nasync function configChannel( event, data ) {\r\n\r\n  let influxConfig = config.database;\r\n\r\n  var channelConfig = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getChannelConfig?instrumentId=\" + data.instrumentId + \"&chanId=\" + data.chanId, { method: 'GET' } ).then( ( response ) => response.json() );\r\n\r\n  var instrumentConfig = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getInstrumentConfig?instrumentId=\" + data.instrumentId, { method: 'GET' } ).then( ( response ) => response.json() );\r\n\r\n  var channelState = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getStatus?instrumentId=\" + data.instrumentId + \"&chanId=\" + data.chanId, { method: 'GET' } ).then( ( response ) => response.json() );\r\n\r\n  //var externalConnection = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getChannelConfig?instrumentId=\" + data.instrumentId + \"&chanId=\" + data.chanId, { method: 'GET' } ).then( ( response ) => response.json() );\r\n  var externalConnection = false;\r\n\r\n  instrumentConfig.instrumentId = data.instrumentId;\r\n\r\n  return openForm( null, \"cellform\", { \r\n    instrumentConfig: instrumentConfig, \r\n    groupName: data.groupName,\r\n    channelConfig: channelConfig, \r\n    channelState: channelState[ data.groupName ].channels[ data.chanId ],\r\n  }, { width: 600, height: 800 } ).then( ( results ) => {\r\n    \r\n    event.sender.send( \"channelConfigured\", results );\r\n    return results;    \r\n\r\n  } ).catch( () => {} );\r\n}\r\n\r\n\r\n\r\nasync function configChannels( event, data ) {\r\n\r\n  let influxConfig = config.database;\r\n\r\n  var channelsState = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getStatus?instrumentId=\" + data.instrumentId + \"&groupName=\" + data.groupName, { method: 'GET' } ).then( ( response ) => response.json() );\r\n  var instrumentConfig = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getInstrumentConfig?instrumentId=\" + data.instrumentId, { method: 'GET' } ).then( ( response ) => response.json() );\r\n  var channelState = await fetch( \"http://\" + data.trackerHost + \":\" + data.trackerPort + \"/getStatus?instrumentId=\" + data.instrumentId + \"&chanId=\" + data.chanIds[ 0 ], { method: 'GET' } ).then( ( response ) => response.json() );\r\n  \r\n    instrumentConfig.instrumentId = data.instrumentId;\r\n\r\n\r\n  return openForm( null, \"cellformall\", { \r\n\r\n    channelState: channelState[ data.groupName ].channels[ data.chanIds[ 0 ] ], \r\n    channelsState: channelsState[ data.groupName ].channels, \r\n    groupName: data.groupName,\r\n    instrumentConfig: instrumentConfig,\r\n    channelIds: data.chanIds\r\n\r\n  }, { width: 600, height: 800 } ).then( ( results ) => {\r\n  \r\n    event.sender.send( \"channelsConfigured\", results );\r\n    return results;    \r\n    \r\n  } ).catch( () => {} );\r\n}\r\n\r\n\r\n\r\n\r\n\r\nlet windowForm;\r\n\r\nfunction openForm( windowName, pageName, formData, options = { width: 300, height: 420 }, onClose ) {\r\n\r\n  if( windowForm ) {\r\n    ( windowForm._rejecter && windowForm._rejecter() );\r\n    windowForm.close();\r\n  }\r\n  // Create the browser window.\r\n  windowForm = new BrowserWindow( options );\r\n\r\n  // and load the index.html of the app.\r\n  windowForm.loadURL( url.format({\r\n    pathname: path.join(__dirname, 'app/' + pageName + '.html'),\r\n    protocol: 'file:',\r\n    slashes: true\r\n  }) );\r\n\r\n  windows[ \"form\" ] = windowForm;\r\n\r\n  windowForm.once(\"closed\", () => {\r\n    windows[ \"form\" ] = null;\r\n    ( windowForm && windowForm._rejecter && windowForm._rejecter() );\r\n    windowForm = null;\r\n\r\n    if( typeof onClose == \"function\" ) {\r\n      onClose();\r\n    }\r\n\r\n  })\r\n  return new Promise( ( resolver, rejecter ) => {\r\n    \r\n    ipcMain.once(\"validateForm\", ( event, data ) => {\r\n\r\n      resolver( data );\r\n    });\r\n\r\n    ipcMain.once(\"closeForm\", ( event, data ) => {\r\n\r\n      if( windowForm ) {\r\n        windowForm.close();\r\n        windowForm = null;\r\n      }\r\n    });\r\n\r\n    windowForm.webContents.once(\"dom-ready\", () => {\r\n      windowForm.webContents.send(\"loadForm\", formData );\r\n    });\r\n     \r\n\r\n    windowForm._rejecter = rejecter;\r\n  });\r\n}\r\n"]}